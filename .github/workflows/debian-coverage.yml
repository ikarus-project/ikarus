name: CodeCoverage
on:
  push:
    paths-ignore:
      - 'docs/**'
      - '.github/workflows/ghpages.yml'
env:
  CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

jobs:
  GCC-Debug-CodeCov:
    runs-on: ubuntu-latest
    container:
      image: rath3t/ikarus-debian-bookworm:latest
      options: --memory-swap="20g" --memory="20g" --cpus="2"

    steps:
      - uses: actions/checkout@v2
      - name: test vars
        run: |
          echo $CI
          echo $GITHUB_ACTIONS
      - name: Create Work Dir
        run: |
          update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-12 110 --slave /usr/bin/g++ g++ /usr/bin/g++-12 --slave /usr/bin/gcov gcov /usr/bin/gcov-12 --slave /usr/bin/gcc-ar gcc-ar /usr/bin/gcc-ar-12 --slave /usr/bin/gcc-ranlib gcc-ranlib /usr/bin/gcc-ranlib-12
      - name: Build
        run: |
          mkdir cmake-build-debug
          cd cmake-build-debug
          cmake ../  -DCMAKE_BUILD_TYPE=Debug -G "Unix Makefiles" -DCMAKE_C_COMPILER=gcc-12 -DCMAKE_CXX_COMPILER=g++-12 -DENABLE_TEST_COVERAGE=1
          cmake --build . --parallel 2 --target IkarusTests

      - name: Tests
        working-directory: ./cmake-build-debug
        run: |
          ctest --output-on-failure --parallel 2 -C Debug
          cd ..
          gcov -abcfu $(find ./cmake-build-debug/tests/CMakeFiles/IkarusTests.dir/src -type f -name "*.gcno" | sed  's/gcno//g')
          ls

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v2
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          flags: tests
          fail_ci_if_error: true # optional (default = false)
          verbose: true # optional (default = false)
